{
    "collab_server" : "",
    "contents" : "MicrobiomeStats <- R6Class(\"MicrobiomeStats\",\n    private = list(\n      microbiome_study_obj = NULL\n    ),\n    active = list(\n      microbiome_study = function(microbiome_study){\n        if(missing(microbiome_study)) return(private$microbiome_study_obj)\n        private$microbiome_study_obj = microbiome_study\n      }\n    ),\n   public = list(\n     initialize = function(microbiome_study) {\n       private$microbiome_study_obj <- microbiome_study\n     },\n\n     calculate_correlation = function(taxonomy_level = \"Phylum\", cor_type = \"tm\"){\n\n       if(identical(cor_type, \"tm\") |  identical(cor_type, \"mm\")){\n         quantitative <- private$microbiome_study_obj$sample_table$get_quantitative_metadata()\n         filtered_categories <- private$microbiome_study_obj$sample_table$get_filtered_categories()\n\n         quantitative <- quantitative[ quantitative %chin% filtered_categories ]\n         metadata_data <- private$microbiome_study_obj$get_metadata_as_column(quantitative)\n         metadata_data[,SampleName:=NULL]\n\n         cols <- colnames(metadata_data)\n\n         metadata_data[, (cols) := lapply(.SD, as.numeric), .SDcols = cols]\n         factor2<-metadata_data\n         if(identical(cor_type, \"mm\")){\n           factor1<-factor2\n           column_factor1<-\"metadata.1\"\n           column_factor2<-\"metadata.2\"\n         }else{\n           column_factor2<-\"metadata\"\n         }\n       }\n       if(identical(cor_type, \"tm\") |  identical(cor_type, \"tt\")){\n         abundance_data <- private$microbiome_study_obj$get_otu_as_column(taxonomy_level)\n         abundance_data[,SampleName:=NULL]\n\n         cols <- colnames(abundance_data)\n         abundance_data[, (cols) := lapply(.SD, as.numeric), .SDcols = cols]\n         factor1<-abundance_data\n\n         if(identical(cor_type, \"tt\")){\n           factor2<-factor1\n           column_factor1<-paste0(taxonomy_level,\".1\")\n           column_factor2<-paste0(taxonomy_level,\".2\")\n         }else{\n           column_factor1<-taxonomy_level\n         }\n       }\n       number_rows <- ncol(factor1)*ncol(factor2)\n\n       # pairwise.complete<-cor(data.cor,consumo, method=\"spearman\", use=\"pairwise.complete.obs\")\n\n\n\n       result<-data.table(\"taxon\"=character(),\"metadata\"=character(),\"rho\"=numeric(),\"p\"=numeric(),\"psize\"=numeric())\n\n       columns_data<-colnames(factor1)\n       columns_metadata<-colnames(factor2)\n       for(i in 1:length(columns_data)) {\n         for (j in 1:length(columns_metadata)) {\n           NA_ = which(is.na(factor2[,..j]))\n           if(length(NA_)>0){\n             rho = cor(factor1[[i]][-NA_], factor2[[j]][-NA_], method = \"spearman\")\n             p = cor.test(factor1[[i]][-NA_], factor2[[j]][-NA_], method = \"spearman\")[3]$p.value\n           }else{\n             rho = cor(factor1[[i]], factor2[[j]], method = \"spearman\")\n             p = cor.test(factor1[[i]],factor2[[j]], method = \"spearman\")[3]$p.value\n           }\n           if(!is.na(rho)){\n             line<-data.table(columns_data[i], columns_metadata[j], rho, p, log10(0.5+2/p))\n             result<-rbindlist(list(result, line))\n           }\n         }\n       }\n       result<-subset(result, taxon!=metadata)\n       colnames(result)<-c(column_factor1, column_factor2, \"rho\", \"pvalue\", \"size\")\n\n       result\n     }\n   )\n)\n",
    "created" : 1500543766906.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "4103619293",
    "id" : "517F6D55",
    "lastKnownWriteTime" : 1500546191,
    "last_content_update" : 1500546191909,
    "path" : "~/Projects/microbiomedb/common/mbiome/R/mbiome-stats.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 5,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}